const jsonServer = require('json-server');
const server = jsonServer.create();
const router = jsonServer.router('mock/db.json');
const middlewares = jsonServer.defaults();

let cycle = 0;
const price = 0.04004684838480379;
const getIotas = () => Math.round(price * 1000000);
let address;

function randStr(len) {
  let s = '';
  while (s.length < len) s += Math.random().toString(36).substr(2, len - s.length);
  return s;
}

server.use(jsonServer.bodyParser);

server.use(jsonServer.rewriter({
    '/market/iota/quotes': '/market_iota_quotes',
  },
));

const addressData = () => {
  return {
    'createdAt': 1570218445470,
    'uuid': 'addressCounter',
    'addressIndex': 376,
    'state': 'created',
    'seedId': 1,
    'addressId': address,
    'balances': {
      'balances': [0],
      'references': ['TXILCQMSHJA9YOYQYLQTNLVXIAQSBIIHTJTPPAWAXXVZXNYH9QGXEKZCTTWB9TSGHXJBAH9SHRDOA9999'],
      'milestoneIndex': 1197704,
      'duration': 0,
    },
    'transactions': [],
  };
};

const addressDataWithTransactions = confirmed => {
  return {
    'createdAt': 1570267547468,
    'uuid': 'addressCounter',
    'addressIndex': 378,
    'state': 'created',
    'seedId': 1,
    'addressId': address,
    'balances': {
      'balances': [confirmed ? getIotas() : 0],
      'references': ['TXILCQMSHJA9YOYQYLQTNLVXIAQSBIIHTJTPPAWAXXVZXNYH9QGXEKZCTTWB9TSGHXJBAH9SHRDOA9999'],
      'milestoneIndex': 1198351,
      'duration': 0,
    },
    'transactions': [{
      'hash': 'SRPSQWCKLBGMNCVTUVWMBUTADMMMGNX9O9DCAPTEQMBAVNHTXAFSWOYYWJFFVNSUARFIMR9TLOQJ99999',
      'signatureMessageFragment': '999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999',
      'address': '9D9L9GRKSHTGPS9PGVYKQWVUVOXCTICWANMQBUFBZEHZLEBISDHBVPALEWIYKWGYHDDCDHRL9LXLVVTTY',
      'value': getIotas(),
      'obsoleteTag': 'HRINITY99999999999999999999',
      'timestamp': 1570267646,
      'currentIndex': 0,
      'lastIndex': 3,
      'bundle': 'OANNCY9INFTBRNKZLRQECDZGJAJSCFHHZLFDRSSLXYAHYPYGGDAEJWBHWOQIJXRKJEG9DQDJ9AXTHRHEC',
      'trunkTransaction': 'BPDFICAUNGRY9GBFUBQ9HXJ9BXHEROVSAVIEGFBWPDPCVKGHPTWGLYUWCWARLYMCBLNMZNAHNICNZ9999',
      'branchTransaction': 'PRNSUXSCH9IBOT9DWOCETMQBINAZFFWUBLQGTWITHHAVMYSMMAYMZRUJAEGTZLKKLZH9XQCKKBPSA9999',
      'tag': 'TRINITY99999999999999999999',
      'attachmentTimestamp': 1570267661967,
      'attachmentTimestampLowerBound': 0,
      'attachmentTimestampUpperBound': 3812798742493,
      'nonce': 'NCPDFZY9LBOMKVWFUGPCEIRWWAC',
      'confirmed': confirmed,
    }],
  };
};

const addressDataThirdpartyPayment = confirmed => {
  return {
    'createdAt': 1570267547468,
    'uuid': 'addressCounter',
    'addressIndex': 378,
    'state': 'dirty',
    'seedId': 1,
    'addressId': address,
    'balances': {
      'balances': [confirmed ? 0 : getIotas()],
      'references': ['9HETHULKOLLWHPKBYLSUQFLVEKESOQVASSYXEGRNMXENKARBSILGRPKCRUOCDOSFDWCBPJIYP9GQZ9999'],
      'milestoneIndex': 1198353,
      'duration': 1,
    },
    'transactions': [{
      'hash': 'VBTBWEXBDDBYZAEMSFNXGW9BMQOHDORNEOFERSVASGHROZLJJMRDFELOIXVKOOHFXNW9OEVSSXUCA9999',
      'signatureMessageFragment': 'OWRBRAAFOQXQRXRMNUYTOKKUVKXQCCJXGUAHGMIWHHIGYDAAWISTQJDHWPRGUIFDAQZDOHOS9NMEBXXSWPRBCIEFWCSKDYALOSRMGXWN9AFNVISKSGQNEMPNHAXAEGKCYEIHYYJZBQYAXHGYAOZDAVD9QBMCZPSRTZOIEKHRHCWTRFXUPA9FOPQCBMCBCUMGHSBPKAVHSSIEZIGXZYJTUAYUPHRSDLCW9KWYBZGNHZGFFYRQNNXCEWERQX9BFTTBVSEUY9MGFJIDTAQROFMLTYBSILGAVFHQQFDFPILXIQFTQQJSBUGJJIFBWAENMVAQFWB9TQNO9GNINCLGZZ9IWVZQPTTBVMHQUJWYBYBPXLAXJOPFCHEWAOETNTYUK9ZWORTTUXFFWDPNRKQRPAYMBKOLRVGTEYXHRQQRXYURTCD9CZYDQGXZGKDNGIFK9UVQWWBEPI9PBW9MZFSW9XFUVU9MADZVZKFFDBZK9DCQXQXWIJOJFESKLSCVEEJGPKLEELD9JOTGTYQEINKIULIHCGRUBORFTBGSFGXAPIRUWSZWTUDHDLHTEYWHNFKUVFCKKPKQVHQJXGYKSIJUDSNULEU9BMZQOXDTXPK9IBWCGXGZALXQGGSKLCMTXVUMLYKECELYDOD9PHT9RWZEBOHSJLMFINBTELLSRCJOQDLORNMNMXYINNOEQXTQSNCHMJ9O9VSLQQZGEVRWCXYUJVEHHRKTD9KJDPNSZRIZNNBADDTVXRBTWZYC9GDXIYJIJU9Y9K9QADYAQHVZPFXGCEOYYVIE9PONMVSYFPVAFMJ9IWGAIVFRKBI9VHFCNVYMKQOCIQTICJVWMGZDAWKNCVGFOKZBCHSGCOOAJMKUONORHXNSVQIRSNIUGRGHZTDOMUGPQPZTPXOYEOER9LNM9DINLGVBJVCYMAENNSO9GIMZHBUPPSXOFAFMMFRTSPKNLKUGXNWWJRHT9PPXKRYGSWOZ9IICGNICZDXY9E9NIYITIZUZIPYNPPDXAOG9LJ99HAOEEWFXTMMYKKDMVGTMLVLBGEQQGFXJALCZYVIRMQDYNLVAKJNPMWHEZUWIZSZGILZFWYPMIWPLHDAAQLQZCRYZLRHIAUFFNMVMGSFFNBTKISHFTXDFRZIGRIY9IDQDVKOHKESEBDUDDNKNRFDQBIHXB9RXZRLTDHPLXMW9KCI9PMRKGROOFSXYGFEJEGJWWKD99QLMSGMYCWDLJZRCKDSUWIV9WTCXHDVNH9RGWKSVZMLKQZRM9PPGX9ZXXXBGAYWSJUWZQYTJTQGEANUWF9ZA99ORUNAZQCDMYHUEPXECGHXEKH9PPUE9JOTHJHJTDCINRWKGMNPDNZFHXBZGWYNQVCGVNHVHU99SWRUKDDMDPHXLRKMICHQNLEPRGXFZTWCPTWCSWLUYAFTUIK9HVZAAANXDHKTQVNNLYGEBCEUONRYRGDOKJBILADVWSPKFZMYF9SZRS9PYJEZKQPCRCQBFBVN9VWGJWVEVALFAEQHZHUK9HSWFHYH9MGPVSEGEXOUCUI9QRGFNFNGZHDCZWVZTJKJX9SYGEWDSMKBW9QYZVSFRLR9KCERMZHPOMDVJRBDWZMD9VHIJMQKDVCPFNZTXFAXVYIJKTIL9YKVQMIHELTRFJNEB9DVWDHPBXRVAQPORWHFEQMJMVHECACIXLWOAGNJIEVDBL9YFBNOGYHHUINMJIGOWYBOCAMBNRLDLLEZYAWBOQDCWETXKGUPIKJMN9WKL9RNJATJPMTOMIZTTSRKENXFTEXVMYXSWCAKIVBKYHLVYBCMTTVKVVBGLUKXT9FFDYLUNCXCCVLYRHJBABIZWPNA9HFLKQDSHD9UEEOGGSUOIPFDWU9SZNUJVAPWOOEWBKZW9GZMQSLXTOQWYU9NPFCWKOLAJQIPYWLDMHQSBVVQXREETHWGMWNLZBHAAHHRXMITPWESZANBWRQRZS9KOVWNVS9SKCLYOUAAZBXVLOPNXMFTUJHNQNXVAHYKMIIQSCCZEFDIQHVCMLUTJCLIWIFOOAQVFJEYPGUDGSOKBHWYKDBWNDNGMHMH9HXQAACSJUDENOFVKZNOYMRUKGYPHMTIWKZSZXQUDXWNMTWEGLZRJIZLIOGNQNYPVHJPFCQIDDMELJQJOBRERXAGEFPKXMMSIYJCYCLITEKH9OYLCROLBWHOWYNC',
      'address': '9D9L9GRKSHTGPS9PGVYKQWVUVOXCTICWANMQBUFBZEHZLEBISDHBVPALEWIYKWGYHDDCDHRL9LXLVVTTY',
      'value': 0,
      'obsoleteTag': '999999999999999999999999999',
      'timestamp': 1570267721,
      'currentIndex': 2,
      'lastIndex': 3,
      'bundle': 'HAMEPXRAQIRIVUHHJIESIDYUDKVEHFVQFGEAZLJXTVKSZJU9TAXGJQPWIUSCEVNJQY9AQBGIKPIDDDJOA',
      'trunkTransaction': 'VVDMBJEFYUWDNBIWDNSHLWUN9FGSIYWZRRNPWOJJHAPTTGDBMY9I9IVKQHJFYVOAHNQISSHNJEAGZ9999',
      'branchTransaction': 'CFDZVAGXABFVVBCMIO9YHACUWNNLDRRYPPFTCGPTMZBGBGESQTJMXCCOREUEBQMPPIYDJCERUUNO99999',
      'tag': '999999999999999999999999999',
      'attachmentTimestamp': 1570267723686,
      'attachmentTimestampLowerBound': 0,
      'attachmentTimestampUpperBound': 3812798742493,
      'nonce': 'CBKAHPHPQBJMBDZH9DLEDWQBEYB',
      'confirmed': true,
    }, {
      'hash': 'SRPSQWCKLBGMNCVTUVWMBUTADMMMGNX9O9DCAPTEQMBAVNHTXAFSWOYYWJFFVNSUARFIMR9TLOQJ99999',
      'signatureMessageFragment': '999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999',
      'address': '9D9L9GRKSHTGPS9PGVYKQWVUVOXCTICWANMQBUFBZEHZLEBISDHBVPALEWIYKWGYHDDCDHRL9LXLVVTTY',
      'value': getIotas(),
      'obsoleteTag': 'HRINITY99999999999999999999',
      'timestamp': 1570267646,
      'currentIndex': 0,
      'lastIndex': 3,
      'bundle': 'OANNCY9INFTBRNKZLRQECDZGJAJSCFHHZLFDRSSLXYAHYPYGGDAEJWBHWOQIJXRKJEG9DQDJ9AXTHRHEC',
      'trunkTransaction': 'BPDFICAUNGRY9GBFUBQ9HXJ9BXHEROVSAVIEGFBWPDPCVKGHPTWGLYUWCWARLYMCBLNMZNAHNICNZ9999',
      'branchTransaction': 'PRNSUXSCH9IBOT9DWOCETMQBINAZFFWUBLQGTWITHHAVMYSMMAYMZRUJAEGTZLKKLZH9XQCKKBPSA9999',
      'tag': 'TRINITY99999999999999999999',
      'attachmentTimestamp': 1570267661967,
      'attachmentTimestampLowerBound': 0,
      'attachmentTimestampUpperBound': 3812798742493,
      'nonce': 'NCPDFZY9LBOMKVWFUGPCEIRWWAC',
      'confirmed': true,
    }, {
      'hash': '9QNDRFBSZSIJUVCZBIMEDRKBUZGAYZAAGHLGTYRYWBIXEJNPS9YMADZWPRZEGJPUUXFHTEYJR9NFZ9999',
      'signatureMessageFragment': 'EYRTVPCBGIZVZWXMSIIUNDYOZVONNMBTOGRU9LGGYUQJXSPSSUIXF9KDJXSYTLCTUNWYTMELALWEXSEDDSROBNHFQXZJU9LZFPXBLJ9VFXIZTPIMSZXUWRYUZAJDGFRPTXSWZJTQRJTCXVQBUUVZPQLHIRKB9HNSLBWOUXUXXDGLRDGGYOUXSTXPCTFGZNAXZYNIJTOLCLELYJBAJWMLLZPTGQSKWUJOCZCTQSCVGR9PNLOKNWWLEMLZT9COPWVCTPXVXPWCVCYFAAERCLVOAOWZRBD9MEEPCIU9YEBLYBJZWFMK9GOCBSXEHJZKDHFSOTTCCXHDULSOVXXMTSYSDDZKYVPDDISOMPXWAHZRMXBXQHOSVLJIPLCZGHPXRCISITOUDOVHBBNLGYCGWLJSCGPZATNFUMEAFRSWKDWUJHIQBNDKKDNXNEJSMIITLJMIY9EXAUHKCCLFUXKCGKNBCPCMFPIOWOTDZN9SFZDNOETT9HHLXOLLPHSVDEVWWHHLHZGDFDJQTFPPVLJWNOLTGMKHTUIFNOHISDSOYHFRSYZFHOFGCZ9ZSEWXYMEUHIYKSECKYTTTEXLSBVW9VNCHQJNZSTLKMN9DCQFKDUXTLTBOFORYNTBYTGZXCNHUVTWQQXHN9VQWEIBUK9FIEOYCRJQBECYTBNJLZGUDYDKSHZKNQABIUTKQHVMKDOOSGLQEPZGXTAHCEIJB9S999LVAYQNXAGAWMOODP9PBADKDNCJLWCCTH9EDAVSFSNYMTWYEFMDTFEOKLKCC9TAVNLEIZUMGPZDWIXYWPXHQ9QDNTXEEUTUBNGVEXJC9EYBFGEUGB9LMYGVHJRYERVNLJRSRIPLAGMHTLBLTFTH9Y9QDYSMAXOIJ9PCZXHPNTBAIOSLSSCLOJBAFKADAWLFIEBIXUSEPJW99YRWBKEJFJAQXFVPFRCKWPUFRF9TTMJKGWRUWADJAGJAAJECAHTWPZRGEBDLMQFLEUKAMPLSFWQPWTWUBVSL9IXVTWFCLUSPGHNEWKLXZ9XEBRHXKUISRYVQLDGFHWVNRX9J9SHNLAEVPAZHRMFCL9SHUSFKHJL9AGPY9YQLUCJVNQACRPGUHEGTMKFSOPHXIKWOYTBGBCMKCMQDITDKEGQKVNLULNDGVWVOJUOVPN9VPZZIRHCTGJAIQIFWFPTL9UQHFZIUPYTXPEJYPDZPXZSWHFMIAXPLIHSZZHQEYKJPFYTIXEZXWPF9IHNSEVKXWDUGYYZOFMHLADFEQCHBNLMSNRCLGKVRDJ9QSOYNQVCKTRWAYPUVDHS9IBREGEYSDYBSQQPUAWEOJLX9XI9QA9EXCUAIWTOKUFZVENFEOOKUSCEYXEEVUKYMLWYGUCNTJCCLDWFKMEDTJHNU9BGYFAQBWZRITZQUCL9IROJMOEBMURLMGUISPNJJQPDNUQTYKEH9WUDOTVYRMCOVRHHJUVXXCYFIRXBLFFDGLUTBCCCRXMQJJVTSQAG9NXKJBEVIJCLWDI9JDMWNZIMCTMBEIITWMSZFKSCUGFIY9IUDYKQCLSWURMGXZVUZLRQSMPLKQAQFQUCIIOXXWPPUTMHT9BLTDACIKPLZJJFXJEGFDNUFATJSWIJOVGTWDCOPXJMVQDAS9MHGPWUGZXUFVOGYZFOXG9MJQEDLTSPHZSDEWJQJHCECFGHDHCDWZJAHZDSADHSULZEVYDOYAKTJKFWBCJTSGSICKPCCSODJHROPKPOAIBCQKKHGZDEUSGSAFMMRXTSCJLH9BK9HPKSAMEPCSLIHHPBVZZVYUEQMU9UK9CSYYSYDVYIHSLMAKWDBOLTZVRASFA9OQKULIEBWQFEBMBWPELTR9LBOIXDFHWFSKJPZA9MJQNDDGTXHNGSDFZTRHNDIUBLDOGUEQXWOAWDCLVDXUMWECLQZ9SLSMBYUBFNYPLIGAHBFFMDEHHQPCKYEWGGPEMOMYBCYJSZHLEKLMVLMNPMLUSFFCAJ9JKNIKGJW9Z9VHQQNMSEUBQVNMJSSVTVEIZOFIQIJTXGLJDGF9NFQOBHFNTYMSIKNMZHMYQWYHLBPK9SFMPJURFRG9HY9VVCSMMQEMRI9XJDPVZRGTKDIDBTSNWZPJQYJGEADENNSWHYDNAMVVGUQMAJQQYFIXRNDUEIMVJOMSNOOZRFX9LBXKZXKSJYOAF9UBOAFHKFAOOW9',
      'address': '9D9L9GRKSHTGPS9PGVYKQWVUVOXCTICWANMQBUFBZEHZLEBISDHBVPALEWIYKWGYHDDCDHRL9LXLVVTTY',
      'value': -(getIotas()),
      'obsoleteTag': '999999999999999999999999999',
      'timestamp': 1570267721,
      'currentIndex': 1,
      'lastIndex': 3,
      'bundle': 'HAMEPXRAQIRIVUHHJIESIDYUDKVEHFVQFGEAZLJXTVKSZJU9TAXGJQPWIUSCEVNJQY9AQBGIKPIDDDJOA',
      'trunkTransaction': 'VBTBWEXBDDBYZAEMSFNXGW9BMQOHDORNEOFERSVASGHROZLJJMRDFELOIXVKOOHFXNW9OEVSSXUCA9999',
      'branchTransaction': 'CFDZVAGXABFVVBCMIO9YHACUWNNLDRRYPPFTCGPTMZBGBGESQTJMXCCOREUEBQMPPIYDJCERUUNO99999',
      'tag': '999999999999999999999999999',
      'attachmentTimestamp': 1570267727163,
      'attachmentTimestampLowerBound': 0,
      'attachmentTimestampUpperBound': 3812798742493,
      'nonce': 'XWEJLQDHHLYIEVMVGCJYGCZISAR',
      'confirmed': true,
    }],
  }
};

server.post('/addresses', (req, res) => {
  cycle = 0;
  address = randStr(90);
  // Test error
  // res.header('access-control-allow-origin', '*').sendStatus(502);

  res.header('access-control-allow-origin', '*')
    .jsonp(
      {
        'index': 376,
        'address': address,
      },
    );
});

server.get(`/addresses/:address`, (req, res) => {
  let responsedata;
  console.log(`cycle [${cycle}]`);
  if (cycle > 3 && cycle <= 4) {
    responsedata = addressDataWithTransactions(false);
  } else if (cycle > 4 && cycle <= 6) {
    responsedata = addressDataWithTransactions(true);
  } else if (cycle > 6 && cycle <= 8) {
    responsedata = addressDataThirdpartyPayment(false);
  } else if (cycle > 8) {
    responsedata = addressDataThirdpartyPayment(true);
  } else {
    responsedata = addressData();
  }
  res.header('access-control-allow-origin', '*')
    .jsonp(responsedata);
  cycle++;
});

server.post(`/addresses/:address/paythirdparty`, (req, res) => {
  res.header('access-control-allow-origin', '*')
    .jsonp(
      { 'message': 'statemachine for payment started' });
});

server.get('/market/price-conversion/EUR/0.01', (req, res) => {
  res.header('access-control-allow-origin', '*')
    .jsonp(
      {
        'MIOTA': {
          'price': price,
          'last_updated': '2019-10-04T19:21:04.000Z',
        },
      });
});

server.use((req, res, next) => {
  res.header('access-control-allow-origin', '*');
  // if (req.method === 'POST') {
  //   req.body.createdAt = Date.now();
  // }
  // Continue to JSON Server router
  next();
});

server.use(middlewares);
server.use(router);

server.listen(3000, () => {
  console.log('JSON Server is running');
});
